# app.py
import dash
from dash import dcc, html
import dash_bootstrap_components as dbc
from dash.dependencies import Input, Output
from data.loader import load_data

app = dash.Dash(__name__,
                use_pages=True,
                external_stylesheets=[dbc.themes.BOOTSTRAP],
                suppress_callback_exceptions=True,
                title="CECL EDA Dashboard")

# Global data load
df = load_data()
app.server.df = df  # Store globally for access in pages

# Navbar for side navigation
sidebar = html.Div(
    [
        html.H2("C&I", className="display-6 text-white px-3"),
        html.Hr(),
        dbc.Nav(
            [
                dbc.NavLink("Home", href="/", active="exact"),
                dbc.NavLink("Univariate Analysis", href="/univariate-analysis", active="exact"),
            ],
            vertical=True,
            pills=True,
            className="bg-dark"
        ),
    ],
    className="sidebar bg-dark text-white p-3",
    style={"height": "100vh", "position": "fixed", "width": "16rem"}
)

content = html.Div(dash.page_container, style={"marginLeft": "18rem", "padding": "2rem"})

app.layout = html.Div([sidebar, content])

if __name__ == "__main__":
    app.run_server(host="0.0.0.0", port=8050, debug=True)


# pages/home.py
import dash
from dash import html

dash.register_page(__name__, path="/")

layout = html.Div([
    html.H1("Welcome to my Home Page", className="display-4"),
    html.P("This is the main page", className="lead")
])

# pages/univariate_analysis.py
import dash
from dash import html, dcc, Input, Output
from eda.analyzers import MissingValueAnalyzer, NumericAnalyzer

dash.register_page(__name__, path="/univariate-analysis")

app = dash.get_app()
df = app.server.df
numeric_vars = df.select_dtypes(include="number").columns.tolist()

layout = html.Div([
    html.H2("Univariate Analysis", className="display-5 mb-4"),
    dcc.Dropdown(
        options=[{"label": col, "value": col} for col in numeric_vars],
        id="variable-dropdown",
        placeholder="Select a variable",
        style={"width": "50%"}
    ),
    html.Div(id="summary-total", className="mt-4"),
    html.Div(id="summary-current", className="mt-4"),
    dcc.Graph(id="plot-output", className="mt-4")
])

@dash.callback(
    Output("summary-total", "children"),
    Output("summary-current", "children"),
    Output("plot-output", "figure"),
    Input("variable-dropdown", "value")
)
def update_dashboard(variable):
    if variable is None:
        return "", "", {}
    analyzer = (
        MissingValueAnalyzer(df, variable) if df[variable].isna().sum() > 0
        else NumericAnalyzer(df, variable)
    )
    results = analyzer.run()

    total_summary = html.Ul([html.Li(f"{k}: {v}") for k, v in results["total_summary"].items()])
    current_summary = html.Ul([html.Li(f"{k}: {v}") for k, v in results["current_summary"].items()])
    
    fig = {
        "data": [
            {
                "x": results["time_series"]["date"],
                "y": results["time_series"]["value"],
                "type": "line"
            }
        ],
        "layout": {"title": f"{variable} Trend Over Time"}
    }
    return total_summary, current_summary, fig



import pandas as pd
from abc import ABC, abstractmethod

# -----------------------------
# Base Class
# -----------------------------
class BaseAnalyzer(ABC):
    def __init__(self, df, variable, time_col="report_date"):
        self.df = df
        self.variable = variable
        self.time_col = time_col

    @abstractmethod
    def run(self):
        pass

# -----------------------------
# Missing % Analyzer
# -----------------------------
class MissingValueAnalyzer(BaseAnalyzer):
    def run(self):
        total = self.df[self.variable].isna().mean() * 100
        current_time = self.df[self.time_col].max()
        current_df = self.df[self.df[self.time_col] == current_time]
        current = current_df[self.variable].isna().mean() * 100

        over_time = (
            self.df.set_index(self.time_col)[self.variable]
            .isna()
            .groupby(pd.Grouper(freq='M'))
            .mean()
            .mul(100)
            .reset_index(name="missing_pct")
        )

        return {
            "total_summary": {"Missing %": round(total, 2)},
            "current_summary": {"Missing %": round(current, 2)},
            "time_series": over_time.rename(columns={self.time_col: "date", "missing_pct": "value"})
        }

# -----------------------------
# Numeric Summary Analyzer
# -----------------------------
class NumericAnalyzer(BaseAnalyzer):
    def run(self):

         self.df[self.variable] = self.df[self.variable].astype(float)

        series = self.df[self.variable]

        total_summary = {
            "Mean": round(series.mean(), 2),
            "Median": round(series.median(), 2),
            "Std Dev": round(series.std(), 2),
            "Min": round(series.min(), 2),
            "Max": round(series.max(), 2),
        }

        current_time = self.df[self.time_col].max()
        current_series = self.df[self.df[self.time_col] == current_time][self.variable]

        current_summary = {
            "Mean": round(current_series.mean(), 2),
            "Median": round(current_series.median(), 2),
            "Std Dev": round(current_series.std(), 2),
            "Min": round(current_series.min(), 2),
            "Max": round(current_series.max(), 2),
        }

        grouped = self.df.set_index(self.time_col).groupby(pd.Grouper(freq='M'))[self.variable]
        over_time = pd.DataFrame({
            "Mean": grouped.mean(),
            "Std Dev": grouped.std(),
            "Min": grouped.min(),
            "Max": grouped.max(),
            "Median": grouped.median(),
        }).reset_index().melt(id_vars=[self.time_col], var_name="Metric", value_name="value")

        return {
            "total_summary": total_summary,
            "current_summary": current_summary,
            "time_series": over_time.rename(columns={self.time_col: "date"})
        }



# ============================
# config/settings.py
# ============================

PROJECT_ID = 'your-gcp-project-id'
DATASET = 'your_dataset_name'
TABLE = 'your_table_name'
TIME_COL = 'report_date'  # or whatever your time column is

# ============================
# data/loader.py
# ============================

from google.cloud import bigquery
import pandas as pd
from config.settings import PROJECT_ID, DATASET, TABLE

def load_data():
    client = bigquery.Client(project=PROJECT_ID)
    query = f"SELECT * FROM `{PROJECT_ID}.{DATASET}.{TABLE}`"
    df = client.query(query).to_dataframe()
    df['report_date'] = pd.to_datetime(df['report_date'])  # adjust as needed
    return df


