import pandas as pd
import numpy as np
from scipy.stats import mannwhitneyu

def run_mannwhitney_by_window(
    df,
    var_list,
    segment_col='commitments_amt',
    segment_cutoff=3_000_000,
    window_list=[(2003, 2005), (2006, 2009), (2010, 2013), (2014, 2017), (2018, 2021), (2022, 2024)],
    date_col='prd_d',
    obligor_id_col='merged_src_ip_id'
):
    df = df.copy()
    df[date_col] = pd.to_datetime(df[date_col])
    df['year'] = df[date_col].dt.year

    results = []

    for start_year, end_year in window_list:
        window_label = f"{start_year}-{end_year}"

        # Filter data for window
        window_data = df[(df['year'] >= start_year) & (df['year'] <= end_year)].copy()
        t0_df = window_data.sort_values(date_col).groupby(obligor_id_col).first().reset_index()

        # Drop rows with missing values in test variables
        t0_df = t0_df[
            (t0_df[segment_col] > 0) &
            t0_df[var_list].notnull().all(axis=1)
        ]

        # Define segment (<=cutoff vs >cutoff)
        t0_df['segment'] = t0_df[segment_col].apply(lambda x: f'≤{segment_cutoff/1e6:.0f}MM' if x <= segment_cutoff else f'>{segment_cutoff/1e6:.0f}MM')

        # Split into groups
        group_low = t0_df[t0_df['segment'].str.startswith('≤')]
        group_high = t0_df[t0_df['segment'].str.startswith('>')]

        # Mann-Whitney test function
        def safe_mw(x1, x2):
            try:
                stat, p = mannwhitneyu(x1, x2, alternative='two-sided')
                return p
            except:
                return np.nan

        row_result = {'window': window_label}
        for var in var_list:
            p_val = safe_mw(group_low[var], group_high[var])
            row_result[f"mw_p_{var}"] = p_val

        results.append(row_result)

    return pd.DataFrame(results)